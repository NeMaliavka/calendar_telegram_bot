# ✅ Retry логика добавлена

## Что было сделано

### 1. Создан модуль `backend/utils/retry.py`
- Декораторы `@async_retry` для асинхронных функций
- Декораторы `@sync_retry` для синхронных функций
- Exponential backoff с настраиваемыми параметрами
- Поддержка списка исключений для retry

### 2. Добавлена retry логика для GigaChat API
**Файл:** `backend/core/llm_service.py`

**Функции:**
- `correct_user_query()` - коррекция запросов пользователя
- `is_query_relevant_ai()` - проверка релевантности
- `get_llm_response()` - получение ответа от LLM

**Параметры:**
- Максимум попыток: 3
- Начальная задержка: 1.0 сек
- Максимальная задержка: 10.0 сек
- Exponential base: 2.0

**Обрабатываемые исключения:**
- `ConnectError` (httpx)
- `TimeoutException` (httpx)
- `HTTPStatusError` (httpx)
- `Exception` (общие ошибки)

### 3. Добавлена retry логика для Google Calendar API
**Файл:** `backend/services/calendar_service.py`

**Методы:**
- `get_busy_slots()` - получение занятых слотов
- `create_event()` - создание события
- `get_user_events()` - получение событий пользователя
- `delete_event()` - удаление события

**Параметры:**
- Максимум попыток: 3
- Начальная задержка: 1.0 сек
- Максимальная задержка: 10.0 сек

**Обрабатываемые исключения:**
- `HttpError` (googleapiclient)
- `ConnectionError`
- `TimeoutError`
- `Exception` (общие ошибки)

### 4. Добавлена retry логика для Google Sheets API
**Файл:** `backend/services/sheets_service.py`

**Методы:**
- `_ensure_headers()` - проверка/создание заголовков
- `add_record()` - добавление записи
- `get_all_records()` - получение всех записей
- `update_record_status()` - обновление статуса записи

**Параметры:**
- Максимум попыток: 3
- Начальная задержка: 1.0 сек
- Максимальная задержка: 10.0 сек

**Обрабатываемые исключения:**
- `HttpError` (googleapiclient)
- `ConnectionError`
- `TimeoutError`
- `Exception` (общие ошибки)

## Как это работает

### Exponential Backoff
При каждой неудачной попытке задержка увеличивается экспоненциально:
- Попытка 1: 1.0 сек
- Попытка 2: 2.0 сек
- Попытка 3: 4.0 сек (но не более max_delay)

### Логирование
Все попытки логируются:
- Предупреждение при каждой неудачной попытке
- Ошибка после исчерпания всех попыток

### Пример использования

```python
from backend.utils.retry import async_retry

@async_retry(
    max_attempts=3,
    initial_delay=1.0,
    max_delay=10.0,
    retryable_exceptions=[ConnectionError, TimeoutError]
)
async def my_api_call():
    # код вызова API
    pass
```

## Преимущества

1. **Устойчивость к временным сбоям** - автоматические повторные попытки
2. **Умная задержка** - exponential backoff не перегружает API
3. **Гибкость** - настраиваемые параметры для каждого вызова
4. **Логирование** - полная информация о попытках

## Тестирование

После добавления retry логики проверьте:

1. **Временные сбои сети** - должны автоматически повторяться
2. **Логи** - должны показывать попытки retry
3. **Производительность** - задержки не должны быть слишком большими

## Настройка

Если нужно изменить параметры retry, отредактируйте декораторы в соответствующих файлах:

```python
@async_retry(
    max_attempts=5,        # Больше попыток
    initial_delay=0.5,     # Меньше начальная задержка
    max_delay=30.0,        # Больше максимальная задержка
    exponential_base=1.5   # Медленнее рост задержки
)
```

